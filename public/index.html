<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppCheckIn</title>
    <style>
        :root { --background-dark: #121212; --surface-dark: #1e1e1e; --primary-accent: #008cff; --text-primary: #ffffff; --text-secondary: #b3b3b3; --border-color: rgba(255, 255, 255, 0.1); --success-color: #28a745; --danger-color: #c82333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--background-dark); color: var(--text-primary); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: var(--surface-dark); border-bottom: 1px solid var(--border-color); }
        h1, h2 { color: var(--text-primary); }
        .main-container { padding: 30px 40px; max-width: 900px; margin: 0 auto; }
        .status-view, .control-card { background: var(--surface-dark); padding: 25px; border-radius: 15px; border: 1px solid var(--border-color); text-align: center; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px; }
        .btn { background-color: var(--primary-accent); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-success { background-color: var(--success-color); }
        #available-rooms-list { list-style: none; padding: 0; }
        .room-item { background: rgba(255, 255, 255, 0.05); margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .room-item-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer; }
        .room-details { display: none; padding: 15px; border-top: 1px solid var(--border-color); }
        .room-image-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .room-image-gallery img { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; }
        .checkout-container { text-align: center; margin-top: 40px; }
        .hidden { display: none; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent); }
        input:checked + .slider:before { transform: translateX(26px); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); }
        .modal-content { margin: auto; display: block; width: 80%; max-width: 700px; padding-top: 50px; }
        .close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; transition: 0.3s; }
        .close:hover, .close:focus { color: #bbb; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loading-message" style="text-align: center; padding: 50px;"><h2>Verificando usuario...</h2></div>
    <div id="client-view" class="hidden">
        <div class="header">
            <h1>AppCheckIn</h1>
            <div><p id="user-email" style="color: var(--text-secondary);"></p><button id="logout-btn" class="btn btn-danger">Cerrar Sesión</button></div>
        </div>
        <div class="main-container">
            <div id="reservation-view" class="status-view hidden"><h2>¡Bienvenido!</h2><p>Haz clic en una habitación para ver las fotos y reservarla.</p><ul id="available-rooms-list"></ul></div>
            <div id="checkin-view" class="status-view hidden"><h2>¡Tu habitación está lista!</h2><p>Has reservado la <strong id="checkin-room-number"></strong>.</p><button id="checkin-btn" class="btn btn-success">Hacer Check-In</button></div>
            <div id="room-view" class="hidden">
                <div style="text-align:center; margin-bottom: 30px;"><h1 id="room-number-header"></h1></div>
                <div class="grid-container">
                    <div class="control-card"><h2>Puerta</h2><button id="door-btn" class="btn">Desbloquear</button></div>
                    <div class="control-card"><h2>Luces</h2><label class="switch"><input type="checkbox" id="light-switch"><span class="slider"></span></label></div>
                    <div class="control-card"><h2>Cortinas</h2><label class="switch"><input type="checkbox" id="curtain-switch"><span class="slider"></span></label></div>
                    <div class="control-card"><h2>AC</h2><label class="switch"><input type="checkbox" id="ac-switch"><span class="slider"></span></label></div>
                </div>
                <div class="checkout-container"><button id="checkout-btn" class="btn btn-danger">Hacer Check-Out</button></div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBJkV7des2EtFX6EHJLUyzHJIvG7P86zGE", authDomain: "desarrolloenlanube-34667-816f5.firebaseapp.com", projectId: "desarrolloenlanube-34667-816f5", storageBucket: "desarrolloenlanube-34667-816f5.appspot.com", messagingSenderId: "438315579198", appId: "1:438315579198:web:51bcb77a9789c1981ade6f" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserProfile = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection('usuarios').doc(user.uid).get().then(doc => {
                    document.getElementById('loading-message').classList.add('hidden');
                    if (doc.exists && doc.data().rol === 'admin') {
                        window.location.href = '/admin.html';
                    } else {
                        currentUserProfile = { id: doc.id, ...doc.data() };
                        document.getElementById('user-email').textContent = user.email;
                        document.getElementById('client-view').classList.remove('hidden');
                        setupClientDashboard();
                        setupClientEventListeners();
                    }
                });
            } else { window.location.href = '/login.html'; }
        });
        
        function setupClientEventListeners() {
            document.getElementById('available-rooms-list').addEventListener('click', (e) => {
                const header = e.target.closest('.room-item-header');
                if (header) {
                    const details = header.nextElementSibling;
                    if (details && details.classList.contains('room-details')) {
                         details.style.display = details.style.display === 'block' ? 'none' : 'block';
                    }
                }
                const img = e.target.closest('.room-image-gallery img');
                if (img) {
                    openModal(img.src);
                }
            });
        }

        function setupClientDashboard() {
            db.collection('reservas').where('clienteId', '==', currentUserProfile.id).where('estado', 'in', ['reservada', 'activa']).onSnapshot(snap => {
                ['reservation-view', 'checkin-view', 'room-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
                if (snap.empty) {
                    document.getElementById('reservation-view').classList.remove('hidden');
                    loadAvailableRooms();
                } else {
                    const res = { id: snap.docs[0].id, ...snap.docs[0].data() };
                    db.collection('habitaciones').doc(res.habitacionId).get().then(roomDoc => {
                       const room = { id: roomDoc.id, ...roomDoc.data() };
                       if (res.estado === 'reservada') {
                            document.getElementById('checkin-room-number').textContent = `Nº ${room.numero}`;
                            document.getElementById('checkin-view').classList.remove('hidden');
                            document.getElementById('checkin-btn').onclick = () => db.collection('reservas').doc(res.id).update({ estado: 'activa' });
                       } else if (res.estado === 'activa') {
                            document.getElementById('room-number-header').textContent = `Habitación ${room.numero}`;
                            document.getElementById('room-view').classList.remove('hidden');
                            setupRoomControls(room.id, room);
                       }
                    });
                }
            });
        }

        function loadAvailableRooms() {
            db.collection('habitaciones').get().then(roomsSnap => {
                db.collection('reservas').where('estado', 'in', ['reservada', 'activa']).get().then(resSnap => {
                    const reservedIds = resSnap.docs.map(doc => doc.data().habitacionId);
                    const available = roomsSnap.docs.filter(doc => !reservedIds.includes(doc.id));
                    const list = document.getElementById('available-rooms-list');
                    if (available.length === 0) {
                        list.innerHTML = '<li>No hay habitaciones disponibles en este momento.</li>';
                        return;
                    }
                    list.innerHTML = available.map(doc => {
                        const room = { id: doc.id, ...doc.data() };
                        const imageGalleryHTML = room.imagenes && room.imagenes.length > 0 ? `<div class="room-image-gallery">${room.imagenes.map(img => `<img src="${img}" alt="Foto de la habitación">`).join('')}</div>` : '';
                        return `<li class="room-item">
                                    <div class="room-item-header">
                                        <span>${room.numero} (${room.tipo}) - $${room.precio}/noche</span>
                                        <button class="btn" onclick="createReservation(event, '${room.id}')">Reservar</button>
                                    </div>
                                    <div class="room-details">${imageGalleryHTML}</div>
                                </li>`;
                    }).join('');
                });
            });
        }

        function createReservation(event, roomId) {
            event.stopPropagation();
            if (confirm("¿Confirmas la reserva de esta habitación?")) {
                 db.collection('reservas').add({ clienteId: currentUserProfile.id, habitacionId: roomId, estado: 'reservada', fecha: new Date() });
            }
        }

        function setupRoomControls(roomId, roomData) {
            const roomRef = db.collection('habitaciones').doc(roomId);
            roomRef.onSnapshot(doc => {
                const data = doc.data().control || {};
                ['light', 'curtain', 'ac'].forEach(key => { document.getElementById(`${key}-switch`).checked = !!data[key]; });
            });

            document.getElementById('door-btn').onclick = () => roomRef.update({ 'control.puerta': 'abriendo' }).then(() => setTimeout(() => roomRef.update({ 'control.puerta': 'cerrada' }), 2000));
            ['light', 'curtain', 'ac'].forEach(key => {
                document.getElementById(`${key}-switch`).onchange = e => roomRef.update({ [`control.${key}`]: e.target.checked });
            });
            document.getElementById('checkout-btn').onclick = () => {
                if(confirm("¿Seguro que quieres hacer check-out?")) {
                    db.collection('reservas').where('habitacionId', '==', roomId).where('estado', '==', 'activa').get().then(snap => {
                        snap.forEach(doc => db.collection('reservas').doc(doc.id).update({ estado: 'finalizada' }));
                    });
                }
            }
        }
        function openModal(imageUrl) { document.getElementById('modalImage').src = imageUrl; document.getElementById('imageModal').style.display = 'block'; }
        function closeModal() { document.getElementById('imageModal').style.display = 'none'; }
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        window.onclick = function(event) { const modal = document.getElementById('imageModal'); if (event.target == modal) { closeModal(); } }
    </script>
</body>
</html>
