<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador - AppCheckIn</title>
    <style>
        :root { --background-dark: #121212; --surface-dark: #1e1e1e; --primary-accent: #008cff; --text-primary: #ffffff; --text-secondary: #b3b3b3; --border-color: rgba(255, 255, 255, 0.1); }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--background-dark); color: var(--text-primary); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; background: var(--surface-dark); border-bottom: 1px solid var(--border-color); }
        .header h1 { color: var(--primary-accent); margin: 0; }
        .header .user-info { display: flex; align-items: center; gap: 20px; }
        #user-email { color: var(--text-secondary); }
        #logout-btn, .btn-danger { background-color: #c82333; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; }
        .container { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; padding: 30px 40px; }
        .content-box { background: var(--surface-dark); padding: 25px; border-radius: 15px; border: 1px solid var(--border-color); }
        h2 { border-bottom: 1px solid var(--primary-accent); padding-bottom: 10px; margin-top: 0; }
        .filter-buttons { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-buttons button, .action-btn { background-color: #333; color: white; padding: 10px 15px; border: 1px solid var(--primary-accent); border-radius: 8px; cursor: pointer; }
        .filter-buttons button.active { background-color: var(--primary-accent); }
        .action-btn { background-color: var(--primary-accent); margin-top: 15px; }
        ul { list-style: none; padding: 0; margin: 0; }
        .item { background: rgba(255, 255, 255, 0.05); margin-bottom: 10px; padding: 15px; border-radius: 8px; }
        .room-item-header { display: flex; justify-content: space-between; align-items: center; }
        .room-item-header-title { cursor: pointer; flex-grow: 1; }
        .room-details { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .room-image-gallery { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .room-image-gallery img, .edit-image-gallery img { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; }
        .edit-image-gallery { display: flex; flex-wrap: wrap; gap: 15px; }
        .edit-image-item { position: relative; }
        .delete-img-btn { position: absolute; top: -5px; right: -5px; background: #c82333; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; line-height: 20px; text-align: center; }
        #user-select, form input, form select, form textarea, form input[type="file"] { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #2a2a2a; color: var(--text-primary); box-sizing: border-box; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: var(--surface-dark); margin: 5% auto; padding: 30px; border: 1px solid var(--border-color); width: 80%; max-width: 600px; border-radius: 15px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #upload-progress { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; border-radius: 5px; background: #333; display: none; margin-top: 10px; }
        #upload-progress::-webkit-progress-bar { background: #333; border-radius: 5px; }
        #upload-progress::-webkit-progress-value { background-color: var(--primary-accent); border-radius: 5px; }
    </style>
</head>
<body>
    <div class="header"><h1>Panel de Administrador</h1><div class="user-info"><span id="user-email"></span><button id="logout-btn">Cerrar Sesión</button></div></div>
    <div class="container">
        <div class="content-box">
            <h2>Clientes</h2><select id="user-select"></select><div id="user-details" style="margin-top: 20px;"></div>
            <div id="new-room-section" style="margin-top: 30px;"><h2>Nueva Habitación</h2><form id="new-room-form"><input type="number" id="room-number" placeholder="Número de Habitación" required><select id="room-type" required><option value="single">Single</option><option value="double">Double</option><option value="suite">Suite</option></select><input type="number" id="room-price" placeholder="Precio por noche" required><textarea id="room-description" placeholder="Descripción"></textarea><label>Imágenes:</label><input type="file" id="room-images" multiple accept="image/png, image/jpeg, image/jpg"><progress id="upload-progress" value="0" max="100"></progress><button type="submit" class="action-btn">Guardar Habitación</button></form></div>
        </div>
        <div class="content-box"><h2>Habitaciones</h2><div class="filter-buttons"><button onclick="filterRooms('all')" class="active">Todas</button><button onclick="filterRooms('available')">Disponibles</button><button onclick="filterRooms('reserved')">Reservadas</button><button onclick="filterRooms('occupied')">Ocupadas</button></div><ul id="room-list"></ul></div>
    </div>
    <div id="imageModal" class="modal"><span class="close" onclick="closeModal('imageModal')">&times;</span><img class="modal-content" id="modalImage" style="background: none; width:auto; max-width: 80%; padding:0;"></div>
    <div id="editRoomModal" class="modal"><div class="modal-content"> <span class="close" onclick="closeModal('editRoomModal')">&times;</span><h2>Editar Habitación</h2><form id="edit-room-form"></form></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBJkV7des2EtFX6EHJLUyzHJIvG7P86zGE", authDomain: "desarrolloenlanube-34667-816f5.firebaseapp.com", projectId: "desarrolloenlanube-34667-816f5", storageBucket: "desarrolloenlanube-34667-816f5.appspot.com", messagingSenderId: "438315579198", appId: "1:438315579198:web:51bcb77a9789c1981ade6f" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        let allRooms = [], allUsers = [], allReservations = [];
        let currentFilter = 'all', currentUser = null;

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                db.collection('usuarios').doc(user.uid).get().then(doc => {
                    if (!doc.exists || doc.data().rol !== 'admin') window.location.href = '/index.html';
                    else loadInitialData();
                });
            } else window.location.href = '/login.html';
        });

        function loadInitialData() {
            db.collection('usuarios').orderBy('email').onSnapshot(snap => { allUsers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); setupUserDropdown(); renderRooms(); });
            db.collection('habitaciones').orderBy('numero').onSnapshot(snap => { allRooms = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderRooms(); });
            db.collection('reservas').onSnapshot(snap => { allReservations = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderRooms(); });
        }
        
        function setupUserDropdown() {
            const userSelect = document.getElementById('user-select');
            userSelect.innerHTML = '<option value="">Seleccione un usuario</option>' + allUsers.map(u => `<option value="${u.id}">${u.email}</option>`).join('');
            userSelect.onchange = () => { document.getElementById('user-details').innerHTML = ''; if (userSelect.value) displayUserDetails(userSelect.value); };
        }

        function displayUserDetails(userId, isEditing = false) { /* Implementación existente */ }
        async function saveUser(userId) { /* Implementación existente */ }

        document.getElementById('new-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            const numero = document.getElementById('room-number').value, tipo = document.getElementById('room-type').value, precio = parseFloat(document.getElementById('room-price').value), descripcion = document.getElementById('room-description').value, files = document.getElementById('room-images').files;
            if (!numero || !tipo || !precio) { alert('Por favor, complete todos los campos requeridos.'); submitBtn.disabled = false; submitBtn.textContent = 'Guardar Habitación'; return; }
            
            try {
                const imageUrls = await uploadImages(files, 'upload-progress');
                await db.collection('habitaciones').add({ numero, tipo, precio, descripcion, imagenes: imageUrls, disponible: true });
                alert('Habitación guardada con éxito.');
                e.target.reset();
            } catch (error) { console.error('Error al guardar la habitación: ', error); alert('Error al guardar la habitación.'); } 
            finally { submitBtn.disabled = false; submitBtn.textContent = 'Guardar Habitación'; document.getElementById('upload-progress').style.display = 'none'; }
        });

        async function uploadImages(files, progressBarId) {
            const progressBar = document.getElementById(progressBarId);
            progressBar.style.display = 'block';
            progressBar.value = 0;
            let uploadedUrls = [];
            if (files.length > 0) {
                const totalSize = Array.from(files).reduce((acc, file) => acc + file.size, 0);
                let uploadedSize = 0;
                const uploadTasks = Array.from(files).map(file => {
                    const storageRef = storage.ref(`habitaciones/${Date.now()}_${file.name}`);
                    const task = storageRef.put(file);
                    task.on('state_changed', snapshot => {
                        const progress = (uploadedSize + snapshot.bytesTransferred) / totalSize * 100;
                        progressBar.value = progress;
                    });
                    return task.then(async snapshot => {
                        uploadedSize += snapshot.totalBytes;
                        const url = await snapshot.ref.getDownloadURL();
                        uploadedUrls.push(url);
                        return url;
                    });
                });
                await Promise.all(uploadTasks);
            }
            progressBar.style.display = 'none';
            return uploadedUrls;
        }

        function renderRooms() {
            const getRoomStatus = (roomId) => {
                const res = allReservations.find(r => r.habitacionId === roomId && ['reservada', 'activa'].includes(r.estado));
                if (!res) return { status: 'available', user: null };
                return { status: res.estado === 'activa' ? 'occupied' : 'reserved', user: allUsers.find(u => u.id === res.clienteId) };
            };
            const roomList = document.getElementById('room-list');
            const filteredRooms = allRooms.filter(room => currentFilter === 'all' || getRoomStatus(room.id).status === currentFilter);
            if (filteredRooms.length === 0) { roomList.innerHTML = '<li>No hay habitaciones que coincidan con el filtro.</li>'; return; }
            
            roomList.innerHTML = filteredRooms.map(room => {
                const { status, user } = getRoomStatus(room.id);
                const imageGalleryHTML = room.imagenes && room.imagenes.length > 0 ? `<div class="room-image-gallery">${room.imagenes.map(img => `<img src="${img}" alt="Foto" onclick="openImageModal('${img}')">`).join('')}</div>` : '<p>No hay imágenes.</p>';
                let details = `<p><strong>Precio:</strong> $${room.precio}/noche</p><p><strong>Descripción:</strong> ${room.descripcion || 'N/A'}</p>`;
                if (user) details += `<p><strong>${status === 'occupied' ? 'Ocupada' : 'Reservada'} por:</strong> ${user.email}</p>`;
                return `<li class="item">
                    <div class="room-item-header">
                        <strong class="room-item-header-title" onclick="toggleDetails(this)">Habitación ${room.numero} (${room.tipo})</strong>
                        <button onclick="openEditModal('${room.id}', event)" class="action-btn" style="margin-top:0; margin-right:10px;">Editar</button>
                        <span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                    </div>
                    <div class="room-details">${imageGalleryHTML}${details}</div>
                </li>`;
            }).join('');
        }
        
        async function openEditModal(roomId, event) {
            event.stopPropagation();
            const room = allRooms.find(r => r.id === roomId);
            if (!room) { alert("Habitación no encontrada."); return; }
            const form = document.getElementById('edit-room-form');
            form.innerHTML = `
                <input type="hidden" id="edit-room-id" value="${room.id}">
                <label>Número:</label><input type="number" id="edit-room-number" value="${room.numero}" required>
                <label>Tipo:</label><select id="edit-room-type" required><option value="single" ${room.tipo === 'single' ? 'selected' : ''}>Single</option><option value="double" ${room.tipo === 'double' ? 'selected' : ''}>Double</option><option value="suite" ${room.tipo === 'suite' ? 'selected' : ''}>Suite</option></select>
                <label>Precio:</label><input type="number" id="edit-room-price" value="${room.precio}" required>
                <label>Descripción:</label><textarea id="edit-room-description">${room.descripcion || ''}</textarea>
                <label>Imágenes Actuales:</label><div id="edit-image-gallery" class="edit-image-gallery">${(room.imagenes || []).map((img, index) => `<div class="edit-image-item" id="img-container-${index}"><img src="${img}"><button type="button" class="delete-img-btn" onclick="markImageForDeletion('${img}', 'img-container-${index}')">&times;</button></div>`).join('')}</div>
                <label style="margin-top:15px;">Añadir Nuevas Imágenes:</label><input type="file" id="edit-room-images" multiple accept="image/png, image/jpeg, image/jpg">
                <progress id="edit-upload-progress" value="0" max="100" style="display:none;"></progress>
                <button type="submit" class="action-btn">Guardar Cambios</button>
                <button type="button" onclick="deleteRoom('${room.id}')" class="btn-danger" style="margin-left: 10px;">Eliminar Habitación</button>`;
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                await saveRoomChanges(room.id);
            };
            document.getElementById('editRoomModal').style.display = 'block';
        }
        
        let imagesToDelete = [];
        function markImageForDeletion(imageUrl, containerId) {
            if (confirm("¿Seguro que quieres eliminar esta imagen?")) {
                imagesToDelete.push(imageUrl);
                document.getElementById(containerId).style.display = 'none';
            }
        }
        
        async function saveRoomChanges(roomId) {
            const form = document.getElementById('edit-room-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            
            const originalRoom = allRooms.find(r => r.id === roomId);
            const updatedData = {
                numero: document.getElementById('edit-room-number').value,
                tipo: document.getElementById('edit-room-type').value,
                precio: parseFloat(document.getElementById('edit-room-price').value),
                descripcion: document.getElementById('edit-room-description').value
            };
            
            try {
                // Delete images marked for deletion
                const deletePromises = imagesToDelete.map(url => storage.refFromURL(url).delete().catch(err => console.error("Error deleting image: ", err)));
                await Promise.all(deletePromises);
                
                // Upload new images
                const newFiles = document.getElementById('edit-room-images').files;
                const newImageUrls = await uploadImages(newFiles, 'edit-upload-progress');
                
                // Combine old and new image URLs
                const remainingImageUrls = (originalRoom.imagenes || []).filter(url => !imagesToDelete.includes(url));
                updatedData.imagenes = [...remainingImageUrls, ...newImageUrls];
                
                await db.collection('habitaciones').doc(roomId).update(updatedData);
                alert("Habitación actualizada con éxito.");
                closeModal('editRoomModal');
            } catch (error) {
                console.error("Error al actualizar la habitación: ", error);
                alert("Error al actualizar la habitación.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Guardar Cambios';
                imagesToDelete = []; // Reset array
            }
        }

        async function deleteRoom(roomId) {
            if (confirm("¿Estás seguro de que quieres eliminar esta habitación? Esta acción no se puede deshacer.")) {
                try {
                    // Check for active reservations
                    const reservation = allReservations.find(r => r.habitacionId === roomId && ['reservada', 'activa'].includes(r.estado));
                    if (reservation) {
                        alert("No se puede eliminar la habitación porque tiene una reserva activa o reservada.");
                        return;
                    }
                    // Delete images from storage
                    const room = allRooms.find(r => r.id === roomId);
                    if (room.imagenes && room.imagenes.length > 0) {
                        const deletePromises = room.imagenes.map(url => storage.refFromURL(url).delete().catch(err => console.error("Error deleting image: ", err)));
                        await Promise.all(deletePromises);
                    }
                    await db.collection('habitaciones').doc(roomId).delete();
                    alert("Habitación eliminada con éxito.");
                    closeModal('editRoomModal');
                } catch (error) {
                    console.error("Error al eliminar la habitación: ", error);
                    alert("Error al eliminar la habitación.");
                }
            }
        }
        
        function filterRooms(filter) { currentFilter = filter; renderRooms(); }
        function toggleDetails(header) { const details = header.parentElement.nextElementSibling; if (details) details.style.display = details.style.display === 'block' ? 'none' : 'block'; }
        function openImageModal(imageUrl) { document.getElementById('modalImage').src = imageUrl; document.getElementById('imageModal').style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
        window.onclick = function(event) { if (event.target.classList.contains('modal')) { event.target.style.display = 'none'; } }
    </script>
</body>
</html>